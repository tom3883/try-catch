<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">

    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v6.js"></script>
    <link rel="stylesheet" type="text/css" href="choropleth.css">
</head>

<body>
    <h1>Choropleth map</h1>

    <svg id="my_dataviz" width="1200" height="630"></svg>
    <div class="tooltip"></div>

    <script>
        // The svg
        const svg = d3.select("svg"),
            width = +svg.attr("width"),
            height = +svg.attr("height");

        // Map and projection
        var path = d3.geoPath();
        const projection = d3.geoMercator()
            .center([0, 20])
            .scale(150)
            .translate([width / 2, height / 2]);

        let data = new Map()
        
        const colorScale = d3.scaleThreshold()
            .domain([100000, 1000000, 10000000, 30000000, 100000000, 500000000]) //default domain
            .range(d3.schemeBlues[7]);

        const yearDisplay = svg.append("text")
            .attr("x", 10)
            .attr("y", height - 10)
            .attr("font-size", "24px")
            .attr("fill", "#b8b8b8");

        //const years = [2012, 2013, 2014, 2015, 2016, 2017];
        let years =Â [];
        let interval;
        
        // Read the years
        d3.csv("/src/choropleth_dataset.csv").then(function (data) {
            data.forEach(function (d) {
                const year = +d.year;
                if (!years.includes(year)) {
                    years.push(year); // Add unique years to the array
                }
            });

            updateMapForYears(years);
            
            interval = setInterval(updateMapForYears, 300, years);
        });

        function updateMapForYears(years) {
            if (years.length > 0) {
                const year = years.shift();
                updateMapForYear(year);
            } else {
                clearInterval(interval);
            }
        }

        let cumulativeSongCount = new Map();

        // each country is initialized to a song count of 0 
        d3.json("/src/world.geojson").then(function (dataGeo) {

            dataGeo.features.forEach(function (country) {
                cumulativeSongCount.set(country.id, 0);
            });
        })

        function updateMapForYear(year) {
            d3.json("/src/world.geojson").then(function (dataGeo) {
                d3.csv("/src/choropleth_dataset.csv").then(function (dataMusic) {
                    const filteredData = dataMusic.filter(d => +d.year === year);
                    let songs_count = [];

                    filteredData.forEach(d => {
                        geoCountry = dataGeo.features.find(data => data.id == d.id);
                        
                        //if there is data for a country for a  year
                        if(geoCountry) {
                            total_song_count_country = cumulativeSongCount.get(d.id) + +d.song_count;
                            cumulativeSongCount.set(d.id, total_song_count_country);
                            songs_count.push(total_song_count_country);
                        }
                    });

                    const quantiles = [0, 0.25, 0.5, 0.75, 1];

                    const quantileValues = quantiles.map(quantile => {
                        return d3.quantile(songs_count, quantile);
                    });

                    const colorScale = d3.scaleThreshold()
                        .domain(quantileValues)
                        .range(d3.schemeBlues[7]);

                    // Clear existing map
                    svg.selectAll("g").remove();

                    const countryPaths = svg.append("g")
                        .selectAll("path")
                        .data(dataGeo.features)
                        .join("path")
                        // draw each country
                        .attr("d", d3.geoPath()
                            .projection(projection)
                        )
                        .attr("stroke", "#b8b8b8")
                        // set the color of each country
                        .attr("fill", function (d) {
                            const countryId = d.id;
                            
                            return colorScale(cumulativeSongCount.get(countryId));
                        })
                        
                    countryPaths.transition()
                        .duration(300) // Adjust the duration as needed
                        .attr("fill", function (d) {
                            const countryId = d.id;
                            return colorScale(cumulativeSongCount.get(countryId));
                        });

                    yearDisplay.text("Year: " + year);
                });
            });
        }

    </script>

</body>
</html>