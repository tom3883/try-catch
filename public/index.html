<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title></title>

	<!-- import the d3 library -->
	<!-- <script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script> -->
    <script type='text/javascript' src='lib/d3.v5.min.js'></script>

	<!-- style sheet 
	<link rel="stylesheet" type="text/css" href="style.css">-->
	<!-- Style sheet -->
    <style>
		/* Add responsive styles for the chart container */
		#chart-container {
            width: 70%; /* Adjust the width for the chart container */
            float: left;
            position: relative; /* Add position: relative */
        }

        #legend-container {
            float: left; /* Float the legend container to the left */
            width: 30%; /* Adjust the width for the legend container */
            height: 100%; /* Make the legend container full height */
            position: relative; /* Add position: relative */
			}

		#menu {
			clear: both;
		}

		#legend {
			position: absolute; /* Position the legend absolutely within its container */
			top: 0; /* Align the top of the legend with the top of the container */
			left: 0; /* Align the left of the legend with the left of the container */
			width: 100%; /* Make the legend full width within its container */
			height: 100%; /* Make the legend full height within its container */
		}

		/* Style for the tooltip */
		#tooltip {
			position: absolute;
			text-align: center;
			width: auto;
			height: auto;
			padding: 5px;
			background: lightgray;
			border: 1px solid #666;
			border-radius: 5px;
			pointer-events: none; /* Prevent the tooltip from blocking mouse interactions with points */
			font-size: 12px;
		}


		#tooltip.hidden {
			display: none;
		}

		
    </style>
</head>

<body>
    <div id="menu">
        <button id="byYear">By Year</button>
        <button id="byPeriod">By Period</button>
    </div>

	<div id="tooltip" class="hidden">
		<p id="country-name"></p>
	  </div>
	  

	<div id="legend-container">
        <div id="legend">
            <!-- Add content to the legend here -->
        </div>
    </div>

    <div id="chart-container">
        <div id="chart"></div>
    </div>

	<script>
		let chart = d3.select("#chart"),
			originalData = null,
			data = null,
			selected = {};

						// Add X axis --> it is a date format
		let years = [1950, 1951, 1952, 1953, 1954, 1955, 1956, 1957, 1958, 1959, 1960, 1961,
				1962, 1963, 1964, 1965, 1966, 1967, 1968, 1969, 1970, 1971, 1972, 1973, 1974, 1975, 1976, 1977, 1978, 1979, 
				1980, 1981, 1982, 1983, 1984, 1985, 1986, 1987, 1988, 1989, 1990, 1991, 1992, 1993, 1994, 1995, 1996, 1997,
				1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015,
				2016, 2017]

		let periods = ['1950-1955', '1955-1960', '1960-1965', '1965-1970']

		var song_count_per_period = new Set();
		var song_count_per_year = new Set();

		var margin = {top: 40, right: 30, bottom: 30, left: 60},
				width = 1000 - margin.left - margin.right,
				height = 600 - margin.top - margin.bottom;

		// append the svg object to the body of the page

		var svg = d3.select("#chart")
			.append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
			.append("g")
				.attr("transform",
					"translate(" + margin.left + "," + margin.top + ")");

		var svg_leg = d3.select("#legend")
			.append("svg")
				.attr("width", width + margin.left + margin.right+ 200)
				.attr("height", height + margin.top + margin.bottom + 200)
			.append("g")
				.attr("transform",
					"translate(" + margin.left + "," + margin.top + ")");


		d3.csv("src/dataset_song_count.csv").then(file =>{
			originalData = file
			data = originalData
			preprocessData()
		});


		// color palette  of 40 colors
		var colors = [
				"#1f77b4", "#aec7e8", "#ff7f0e", "#ffbb78", "#2ca02c", "#98df8a", "#d62728", "#ff9896",
				"#9467bd", "#c5b0d5", "#8c564b", "#c49c94", "#e377c2", "#f7b6d2", "#7f7f7f", "#c7c7c7",
				"#bcbd22", "#dbdb8d", "#17becf", "#9edae5", "#393b79", "#5254a3", "#6b6ecf", "#9c9ede",
				"#637939", "#8ca252", "#b5cf6b", "#8c6d31", "#bd9e39", "#e7ba52", "#843c39", "#ad494a",
				"#d6616b", "#e7969c", "#7b4173", "#a55194", "#ce6dbd", "#de9ed6"
				];

		var color = d3.scaleOrdinal(colors);



		function preprocessData(){


			// format numerical values
			var parseDate = d3.timeFormat("%Y");
			data.forEach(function(d) { 
				d.year = +d.year;
				d.rank = +d.rank;    
				song_count_per_year.add(+d.song_count_per_year);   
				song_count_per_period.add(+d.song_count_per_period); 
			});

			song_count_per_year = Array.from(song_count_per_year);
			song_count_per_period = Array.from(song_count_per_period);


			data = d3.nest()
				.key(function(d) {
					return d['location.country'];
				})
				.entries(data);

			// Sort the entire dataset by year in chronological order
			data.forEach(function(d) {
				d.values.sort(function(a, b) {
					return a.year - b.year;
				});
			});
			




			// Initial chart setup (draw "by period" chart by default)
			time = 'year';
			count = 'song_count_per_year';
			displayChart(data, 'year', 'song_count_per_year');

			d3.select("#byYear").on("click", function () {
				// Clear existing chart and draw "by year" chart
				svg.selectAll("*").remove();
				time = 'year';
				count = 'song_count_per_year';
				displayChart(data, 'year', 'song_count_per_year');
			});

			d3.select("#byPeriod").on("click", function () {
				// Clear existing chart and draw "by period" chart
				svg.selectAll("*").remove();
				time = 'period';
				count = 'song_count_per_period';
				displayChart(data, 'period', 'song_count_per_period');
			});


		}
		// Function to update the chart based on the selected countries
		function updateChart() {
			// Filter the data based on the selected countries
			var selectedData = data.filter(function(d) {
				return selected[d.key];
			});

			// Clear the existing chart
			svg.selectAll("*").remove();

			// Redraw the chart for the selected countries
			displayChart(selectedData, time, count);
		}
	





		function displayChart(selectedData, time, count) {

			var xMin = d3.min(selectedData, function(d) {
				return d3.min(d.values, function(item) {
					return item.year;
				});
			});

			var xMax = d3.max(selectedData, function(d) {
				return d3.max(d.values, function(item) {
					return item.year;
				});
			});

			var yMin = d3.min(selectedData, function(d) {
				return d3.min(d.values, function(item) {
					return item.song_count_per_year;
				});
			});

			var yMax = d3.max(selectedData, function(d) {
				return d3.max(d.values, function(item) {
					return +item.song_count_per_year;
				});
			});

			if (time === 'year') {
				var x = d3.scaleLinear()
					.domain([xMin, xMax])
					.range([0, width]);

				var y = d3.scaleLinear()
					.domain([0, yMax])
					.range([height, 0]);
			} else {
				var x = d3.scaleLinear()
					.domain(d3.extent(periods))
					.range([0, width]);

				var y = d3.scaleLinear()
					.domain([0, yMax])
					.range([height, 0]);
			}

			var xAxis = svg.append("g")
				.attr("transform", "translate(0," + height + ")")
				.call(d3.axisBottom(x).ticks(15).tickFormat(d3.format("d")));

			svg.append("g")
				.call(d3.axisLeft(y));

			selectedData.forEach(function(countryData) {
				svg.selectAll(".line")
					.data([countryData])
					.enter()
					.append("path")
					.attr("fill", "none")
					.attr("stroke", function (d) { return color(d.key); })
					.attr("stroke-width", 1.5)
					.attr("d", function (d) {
						return d3.line()
							.x(function (d) {
								if (time == 'year') {
									return x(d.year);
								} else {
									return x(d.periods);
								}
							})
							.y(function (d) { return y(d.song_count_per_year); })
							(d.values);
					});


				// Remove any existing points
    			//svg.selectAll(".point").remove();

				// Create a unique class for points based on the country's key
				var pointClass = "point-" + countryData.key;



				// ...

				// Create a tooltip element
				var tooltip = d3.select("#chart-container")
								.append("div")
								.attr("id", "tooltip")
								.style("opacity", 0);

				// Function to get the top-3 songs for a specific country and year
				function getTop3SongsForCountryAndYear(countryName, selectedYear) {
					return originalData.filter(function(d) {
						return d.year == selectedYear && d["location.country"] === countryName;
					}).sort(function(a, b) {
						return a.rank - b.rank;
				}).slice(0, 3);
				}

				// Create points (circles) for the selected data
				svg.selectAll("." + pointClass) // Select by the unique class
					.data(countryData.values)
					.enter()
					.append("circle")
					.attr("class", pointClass) // Assign the unique class
					.attr("cx", function (d) {
						return x(d.year); // Use the correct property for the x-coordinate
					})
					.attr("cy", function (d) {
						return y(d.song_count_per_year); // Use the correct property for the y-coordinate
					})
					.attr("r", 3)
					.style("fill", function (d) { return color(countryData.key)})
					.on("mouseover", function(d) {
						console.log("cccc");
						// Show the tooltip with country name, top-3 songs, and period
						var countryName = countryData.key;
						var selectedYear = d3.format(".0f")(d.year);
						var selectedPeriod = d.period;
						var top3Songs = getTop3SongsForCountryAndYear(countryName, selectedYear);

						var tooltipContent = `${countryName}<br>Top-3 Songs (${selectedPeriod}):<br><ul>`;
						top3Songs.forEach(song => {
						tooltipContent += `<li>${song.title} - ${song.name}</li>`;
						});
						tooltip.html(tooltipContent)
						.style("left", (d3.event.pageX + 10) + "px")
						.style("top", (d3.event.pageY - 40) + "px")
						.style("opacity", 0.9);
					})
					.on("mouseout", function(d) {
						// Hide the tooltip on mouseout
						tooltip.style("opacity", 0);
					});


				// ...


			});







			// Add the chart title
			svg.append("text")
				.attr("class", "chart-title")
				.attr("x", width / 2)
				.attr("y", -5) // Adjust the position as needed
				.style("text-anchor", "middle")
				.style("font-family", "Arial, sans-serif") // Change the font-family
				.style("font-size", "16px") // Change the font-size
				.text("Number of songs written in english yearly by different countries"); // Replace "Your Chart Title" with your desired title


			// Add the x-axis label
			svg.append("text")
				.attr("class", "x-label")
				.attr("text-anchor", "middle")
				.attr("x", width / 2)
				.attr("y", height + 30) // Adjust the position as needed
				.style("font-family", "Arial, sans-serif") // Change the font-family
				.style("font-size", "12px") // Change the font-size
				.text("Year"); // Replace with your desired label text

			// Add the y-axis label
			svg.append("text")
				.attr("class", "y-label")
				.attr("text-anchor", "middle")
				.attr("transform", "rotate(-90)")
				.attr("x", -height / 2) // Adjust the position as needed
				.attr("y", -40) // Adjust the position as needed
				.style("font-family", "Arial, sans-serif") // Change the font-family
				.style("font-size", "12px") // Change the font-size
				.text("Song Count"); // Replace with your desired label text



			// Create a legend
			var legend = svg_leg.selectAll(".legend")
				.data(data)
				.enter()
				.append("g")
				.attr("class", "legend")
				.attr("transform", function(d, i) {
					return "translate(0," + (i * 20) + ")"; // Adjust the legend item spacing as needed
				});

			legend.append("rect")
				.attr("x", width + 25)
				.attr("y", 0)
				.attr("width", 15)
				.attr("height", 15)
				.style("fill", function(d) { return color(d.key); })
				.on("click", function(selectedCountry) {
					// Toggle the selected country on click
					var isSelected = !selected[selectedCountry.key];
					selected[selectedCountry.key] = isSelected;
					
					// Update the legend item's opacity based on selection
					d3.select(this).style("opacity", isSelected ? 0.5 : 1);
					
					// Update the chart based on the selected countries
					updateChart();
				});

			legend.append("text")
				.attr("x", width + 50)
				.attr("y", 9)
				.attr("dy", ".35em")
				.style("text-anchor", "start")
				.style("font-family", "Arial, sans-serif") // Change the font-family
   				 .style("font-size", "12px") // Change the font-size
				.text(function(d) { return d.key; });
		}
		

	</script>

</body>
</html>