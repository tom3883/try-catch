<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title></title>

	<!-- import the d3 library -->
	<!-- <script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script> -->
    <script type='text/javascript' src='lib/d3.v5.min.js'></script>

	<!-- style sheet -->
	<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
	<div id="chart"></div>

	<script>
		let chart = d3.select("#chart"),
			originalData = null,
			data = null,
			selected = {};


		d3.csv("src/dataset_song_count.csv").then(file =>{
			originalData = file
			data = originalData
			displayChart()
		});


		function displayChart() {
			// set the dimensions and margins of the graph
			var margin = {top: 10, right: 30, bottom: 30, left: 60},
				width = 1200 - margin.left - margin.right,
				height = 500 - margin.top - margin.bottom;

			var lineOpacity = "0.25";
			var lineOpacityHover = "0.85";
			var otherLinesOpacityHover = "0.1";
			var lineStroke = "1.5px";
			var lineStrokeHover = "2.5px";

			var circleOpacity = '0.85';
			var circleOpacityOnLineHover = "0.25"
			var circleRadius = 3;
			var circleRadiusHover = 6;


			// format numerical values
			var parseDate = d3.timeFormat("%Y");
			data.forEach(function(d) { 
				d.year = +d.year;
				d.rank = +d.rank;    
				d.song_count_per_year = +d.song_count_per_year;   
				d.song_count_per_period = +d.song_count_per_period; 
			});

			// append the svg object to the body of the page
			var svg = d3.select("#chart")
			.append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
			.append("g")
				.attr("transform",
					"translate(" + margin.left + "," + margin.top + ")");

			var sumstat = d3.nest()
				.key(function(d) { return d['location.country']; })
				.entries(data);

			// Sort the entire dataset by year in chronological order
			data.sort(function(a, b) {
				return a.year - b.year;
			});

			// Group the sorted data by country
			var sumstat = d3.nest()
				.key(function(d) { return d['location.country']; })
				.entries(data);

			// Add X axis --> it is a date format
			var years = [1950, 1951, 1952, 1953, 1954, 1955, 1956, 1957, 1958, 1959, 1960, 1961,
			   1962, 1963, 1964, 1965, 1966, 1967, 1968, 1969, 1970, 1971, 1972, 1973, 1974, 1975, 1976, 1977, 1978, 1979, 
			   1980, 1981, 1982, 1983, 1984, 1985, 1986, 1987, 1988, 1989, 1990, 1991, 1992, 1993, 1994, 1995, 1996, 1997,
			    1998, 1999, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015,
				 2016, 2017]
			// Create a linear scale to transform the data
			var x = d3.scaleLinear()
				.domain(d3.extent(years))
				.range([0, width]);

			// Append an X-axis group to the SVG
			var xAxis = svg.append("g")
				.attr("transform", "translate(0," + height + ")")
				.call(d3.axisBottom(x).ticks(15).tickFormat(d3.format("d"))); // Use d3.format to format the tick labels as integers



			// Add Y axis
			var y = d3.scaleLinear()
				.domain([0, d3.max(data, function(d) { return d.song_count_per_year; })])
				.range([ height, 0 ]);
			svg.append("g")
				.call(d3.axisLeft(y));

			// color palette
			var color = d3.scaleOrdinal(d3.schemeCategory10);


			// Create a line chart for each country
			sumstat.forEach(function(countryData) {
				// Draw the line for each country
				svg.selectAll(".line")
					.data([countryData]) // Use an array with the data for the current country
					.enter()
					.append("path")
					.attr("fill", "none")
					.attr("stroke", function(d) { return color(d.key); })
					.attr("stroke-width", 1.5)
					.attr("d", function(d) {
						return d3.line()
							.x(function(d) { return x(d.year); })
							.y(function(d) { return y(d.song_count_per_year); })
							(d.values);
					});

				// Add points (circles) for each data point
				svg.selectAll(".point")
					.data(countryData.values)
					.enter()
					.append("circle")
					.attr("class", "point")
					.attr("cx", function(d) { return x(d.year); })
					.attr("cy", function(d) { return y(d.song_count_per_year); })
					.attr("r", 4) // Adjust the radius of the circles
					.style("fill", function(d) { return color(countryData.key); });

					/*
				// Add text labels for years on the points
				svg.selectAll(".year-label")
					.data(countryData.values)
					.enter()
					.append("text")
					.attr("class", "year-label")
					.attr("x", function(d) { return x(d.year); })
					.attr("y", function(d) { return y(d.song_count_per_year); })
					.attr("dy", -10) // Adjust the vertical positioning of the year labels
					.attr("text-anchor", "middle") // Center the text horizontally
					.text(function(d) { return d.year; });
					*/
			});

			// Create a legend
			var legend = svg.selectAll(".legend")
				.data(sumstat)
				.enter()
				.append("g")
				.attr("class", "legend")
				.attr("transform", function(d, i) {
					return "translate(0," + (i * 20) + ")"; // Adjust the legend item spacing as needed
				});

			legend.append("rect")
				.attr("x", width - 18)
				.attr("width", 18)
				.attr("height", 18)
				.style("fill", function(d) { return color(d.key); });

			legend.append("text")
				.attr("x", width - 24)
				.attr("y", 9)
				.attr("dy", ".35em")
				.style("text-anchor", "end")
				.text(function(d) { return d.key; });


			}

	</script>

</body>
</html>